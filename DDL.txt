CREATE TABLE users (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name VARCHAR(100) NOT NULL,
    email VARCHAR(150) UNIQUE NOT NULL,
    password_hash TEXT NOT NULL,
    role VARCHAR(20) NOT NULL CHECK (role IN ('ADMIN', 'USER')),
    created_at TIMESTAMP DEFAULT NOW()
);

CREATE TABLE devices (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    real_device_id VARCHAR(50) UNIQUE NOT NULL,
    masked_device_id VARCHAR(50) NOT NULL,
    vehicle_plate VARCHAR(20),
    created_at TIMESTAMP DEFAULT NOW()
);

CREATE TABLE sensor_readings (
    id BIGSERIAL PRIMARY KEY,
    device_id UUID REFERENCES devices(id),
    latitude DECIMAL(9,6),
    longitude DECIMAL(9,6),
    speed DECIMAL(6,2),
    fuel_level DECIMAL(5,2), -- porcentaje o litros
    temperature DECIMAL(5,2),
    created_at TIMESTAMP DEFAULT NOW()
);

CREATE TABLE alerts (
    id BIGSERIAL PRIMARY KEY,
    device_id UUID REFERENCES devices(id),
    alert_type VARCHAR(50),
    message TEXT,
    predicted_minutes_left INT,
    created_at TIMESTAMP DEFAULT NOW(),
    resolved BOOLEAN DEFAULT FALSE
);

CREATE TABLE device_user (
    user_id UUID REFERENCES users(id),
    device_id UUID REFERENCES devices(id),
    PRIMARY KEY (user_id, device_id)
);

CREATE TABLE refresh_tokens (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES users(id),
    token TEXT NOT NULL,
    expires_at TIMESTAMP NOT NULL
);


CREATE INDEX idx_sensor_device_time 
ON sensor_readings(device_id, created_at DESC);

CREATE INDEX idx_alerts_device 
ON alerts(device_id);
